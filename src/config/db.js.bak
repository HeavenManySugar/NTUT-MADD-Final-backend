const mongoose = require('mongoose');
const config = require('../config');
const { EventEmitter } = require('events');

// 增加 event emitter 預設限制，避免 MaxListenersExceededWarning
EventEmitter.defaultMaxListeners = 30;

/**
 * 計算最佳連接池大小
 * 基於可用系統資源動態計算
 */
const calculateOptimalPoolSize = () => {
  const cpuCount = require('os').cpus().length;

  // 根據 CPU 核心數量計算最佳連接池大小
  // 每個 CPU 核心使用 5 個連接，至少 10 個，最多 100 個
  const poolSize = cpuCount * 5;

  // 限制連接池大小在合理範圍內
  return Math.min(Math.max(poolSize, 10), 100);
};

/**
 * 建立與 MongoDB 的連接
 * 包含優化的連接選項和池設置
 */
const connectDB = async () => {
  try {
    // 動態計算最佳連接池大小
    const optimalPoolSize = calculateOptimalPoolSize();

    // 添加連接優化選項
    const options = {
      // 生產環境禁用自動創建索引以提高性能
      autoIndex: process.env.NODE_ENV !== 'production',

      // 連接池設置 - 為高負載優化
      maxPoolSize: optimalPoolSize, // 使用計算出的最佳連接池大小
      minPoolSize: 5, // 連接池中維護的最小連接數

      // 超時設置
      connectTimeoutMS: 10000, // 連接超時（10秒）
      socketTimeoutMS: 45000, // 套接字超時（45秒）
      serverSelectionTimeoutMS: 5000, // 伺服器選擇超時（5秒）
      heartbeatFrequencyMS: 10000, // 心跳頻率（10秒）

      // 讀取偏好設置（從離主節點最近的副本讀取，有助於減輕主節點負擔）
      readPreference: 'nearest',

      // 優化寫入關注點 - 用於提高寫入性能
      // 注意：這可能會降低數據一致性保證，根據需求調整
      w: 1
    };
    };

    // 連接到 MongoDB
    const conn = await mongoose.connect(config.mongoURI, options);

    // 增加事件監聽器最大值，避免 MaxListenersExceededWarning
    mongoose.connection.setMaxListeners(20);

    // 開啟查詢緩存
    mongoose.set('bufferTimeoutMS', 30000);

    // 增加全局查詢超時設置
    mongoose.set('maxTimeMS', 30000);

    console.log(`MongoDB Connected: ${conn.connection.host}`);

    // 監聽斷開連接事件
    mongoose.connection.on('disconnected', () => {
      console.log('MongoDB disconnected, trying to reconnect...');
    });

    // 監聽錯誤事件
    mongoose.connection.on('error', (err) => {
      console.error(`MongoDB connection error: ${err.message}`);
    });

    return conn;
  } catch (error) {
    console.error(`Error connecting to MongoDB: ${error.message}`);
    process.exit(1);
  }
};

module.exports = connectDB;
